# Smart Plant AI — API Service Specification (Development Draft)

## Document Metadata
- **Status**: Draft for architecture approval
- **Prepared By**: Codex System Design Team (inspired by Apple/Google best practices)
- **Last Updated**: 2025-02-16
- **Applies To**: Smart Plant AI mobile clients (iOS/Android), future web client, partner integrations

## 1. Purpose & Scope
- Deliver a production-ready API surface that supports plant discovery, AI-driven analysis, care logging, notifications, and insights.
- Provide contracts for the Expo mobile app and future partners while remaining privacy-forward and resilient.
- Explicitly out of scope: marketplace integrations, real third-party weather providers, premium-tier feature gating (pending product decision).

## 2. Guiding Principles
- **Human-centric**: Interfaces mirror real-world entities and workflows.
- **Reliable**: Target 99.9% availability; design for graceful degradation when dependencies fail.
- **Secure**: Enforce OAuth 2.1, short-lived tokens, encryption at rest and in transit.
- **Extensible**: Version endpoints (`/v1`) and evolve via additive fields + experimental headers.
- **Offline-first**: All write endpoints accept client-generated UUIDv7 + idempotency keys for replay safety.
- **Localized**: Thai-first experience with support for multi-locale payloads.

## 3. System Architecture Overview
### 3.1 Service Topology
- **API Gateway**: Terminates TLS 1.3/mTLS, enforces rate limits, performs request validation, routes to services.
- **Identity Service**: OAuth 2.1 provider with PKCE, refresh token rotation, device binding.
- **Plant Registry Service**: CRUD for plants, preferences, and media metadata.
- **Activity Log Service**: Records care activities, enforces validations for Thai units and NPK rules.
- **AI Analysis Service**: Manages analysis sessions, integrates with ML inference and weather snapshots.
- **Notification Orchestrator**: Schedules, categorizes, and dispatches push/local notifications.
- **Insights Engine**: Aggregates analytics, trends, and user-facing metrics from event streams.
- **Async Infra**: Pub/Sub topics (`analysis.analyze`, `notifications.dispatch`) with per-topic DLQs and exponential backoff.
- **Object Storage**: GCS/S3 equivalent for plant imagery (`gs://smart-plants/{userId}/{resourceId}`). Metadata stored in Plant Registry.
- **Search/Analytics**: ElasticSearch for filtered reads; BigQuery for long-term insights.

### 3.2 Key Data Flows
1. **Camera → Analysis → Garden**: Client uploads image → API issues signed URL → Analysis job queued → Result persisted → Plant optionally created/updated → Notifications fired.
2. **Activity Logging**: Client submits activity form → Activity service validates → Preferences updated → Insights recalculated.
3. **Notifications**: Scheduled reminders and AI alerts generated by orchestrator → pushes delivered via Expo/FCM/APNs.

## 4. Domain Model
| Entity | Key Fields | Notes |
| --- | --- | --- |
| `User` | `id`, `email`, `locale`, `settings`, `role`, `createdAt`, `updatedAt` | Role: `owner`, `collaborator`, `viewer` |
| `Plant` | `id`, `userId`, `nickname`, `scientificName`, `status`, `imageRef`, `location`, `preferences`, `timestamps` | `status`: `healthy`, `warning`, `critical`, `archived` |
| `PlantPreferences` | `plantId`, `lastKind`, `lastUnit`, `lastQty`, `lastNPK`, `reminderSettings` | Stored separately but embedded in plant responses |
| `Activity` | `id`, `plantId`, `kind`, `quantity`, `unit`, `npk`, `note`, `timestamp`, `createdBy`, `updatedAt` | Units: `ml`, `g`, `pcs`, `ล.` |
| `Analysis` | `id`, `plantId?`, `imageRef`, `status`, `score`, `issues`, `recommendations`, `weatherSnapshot`, `createdAt` | Status: `queued`, `processing`, `completed`, `failed`, `expired` |
| `AnalysisEvent` | `id`, `analysisId`, `phase`, `message`, `createdAt` | Surfaced via SSE/WebSocket |
| `Notification` | `id`, `userId`, `type`, `payload`, `readAt`, `expiresAt`, `createdAt` | Types: `reminder`, `ai`, `alert`, `achievement`, `system` |
| `Insight` | `id`, `userId`, `metric`, `timeframe`, `value`, `trend`, `confidence` | Metrics: `plantHealthIndex`, `wateringConsistency`, `fertilizerBalance` |
| `AuditLog` | `id`, `actor`, `scope`, `action`, `payloadDigest`, `createdAt` | Append-only; retained 400 days |

## 5. Authentication & Authorization
- OAuth 2.1 with PKCE for mobile clients; confidential clients (back office) use client credentials.
- JWT access tokens: 15-minute lifetime; include `sub`, `scope`, `role`, `locale`, `tenant`.
- Refresh tokens: 24-hour rotation with device binding; revocation list enforced.
- Scopes: `plants.read`, `plants.write`, `activities.read`, `activities.write`, `analyses.read`, `analyses.write`, `notifications.manage`, `insights.read`, `profile.manage`.
- RBAC enforced at gateway + service; shared plants require explicit invitation tokens.
- All write operations audit logged with `actor` derived from token and device fingerprint.

## 6. Request & Response Conventions
- Base URL: `https://api.smartplants.app/v1`.
- Content type: `application/json; charset=utf-8`.
- Envelope schema:
```json
{
  "data": { /* resource */ },
  "meta": { "traceId": "...", "degraded": false },
  "errors": []
}
```
- Timestamps: ISO 8601 UTC (e.g., `2025-02-16T05:04:03Z`).
- Numeric precision: send as strings when fractional precision matters (`"quantity": "500"`).
- Error model aligns with RFC 7807:
```json
{
  "code": "plants/not-found",
  "message": "Plant not found",
  "field": "plantId",
  "hint": "Verify the identifier",
  "traceId": "01HY2X3K3D7Z4"
}
```
- Experimental fields gated via `X-Smart-Plant-Experimental: insights-v2` header.

## 7. API Resources & Endpoints
### 7.1 Users
| Method | Path | Description | Notes |
| --- | --- | --- | --- |
| GET | `/users/me` | Fetch profile, locale, settings, active devices | Requires `profile.manage` scope |
| PATCH | `/users/me` | Update locale, measurement units, notification opt-ins | Partial updates, optimistic locking |
| POST | `/users/me/export` | Initiate full data export | Async; returns job reference |
| DELETE | `/users/me` | Request account deletion/anonymization | Executes 30-day retention unless overridden |

### 7.2 Plants & Preferences
| Method | Path | Description | Notes |
| --- | --- | --- | --- |
| GET | `/plants` | List plants (filters: `status`, `q`, `updatedSince`) | Pagination default 20 items |
| POST | `/plants` | Create manual plant entry | Requires idempotency key header |
| GET | `/plants/{plantId}` | Retrieve plant detail with preferences snapshot | Includes `preferences` if authorized |
| PATCH | `/plants/{plantId}` | Update plant metadata/status | Accepts partial payload |
| DELETE | `/plants/{plantId}` | Soft-delete plant | Response includes `retentionUntil` |
| PUT | `/plants/{plantId}/preferences` | Upsert per-plant defaults and reminder settings | Versioned with ETag |
| GET | `/plants/{plantId}/preferences/history` | Return last 20 preference changes | Audit data only |

### 7.3 Activities
| Method | Path | Description | Notes |
| --- | --- | --- | --- |
| GET | `/plants/{plantId}/activities` | Paginated activity list | Query: `kind`, `from`, `to` |
| POST | `/plants/{plantId}/activities` | Record activity with NPK validation | Requires `Idempotency-Key` header |
| PATCH | `/plants/{plantId}/activities/{activityId}` | Edit activity entry | Audit trail captures diff |
| DELETE | `/plants/{plantId}/activities/{activityId}` | Archive activity | Soft-delete; can restore within 14 days |

### 7.4 Analyses
| Method | Path | Description | Notes |
| --- | --- | --- | --- |
| POST | `/analyses` | Start new analysis session | Returns upload instructions + status |
| GET | `/analyses/{analysisId}` | Retrieve analysis result | Includes AI tips & weather snapshot |
| GET | `/analyses/{analysisId}/events` | Stream analysis progress (SSE) | Upgrades to WebSocket when supported |
| POST | `/analyses/{analysisId}/cancel` | Cancel in-progress analysis | Requires `analyses.write` |
| GET | `/analyses` | List historical analyses | Supports `plantId`, `status`, `since` filters |

### 7.5 Uploads
| Method | Path | Description | Notes |
| --- | --- | --- | --- |
| POST | `/uploads` | Issue signed upload URL + checksum requirement | TTL 5 minutes, single use |
| POST | `/uploads/complete` | Confirm upload completion | Triggers validation + virus scan |

### 7.6 Notifications
| Method | Path | Description | Notes |
| --- | --- | --- | --- |
| GET | `/notifications` | Fetch notifications (filters: `type`, `unread`, `updatedSince`) | Pagination size 50 |
| POST | `/notifications/mark-read` | Batch mark notifications read | Accepts up to 100 IDs |
| POST | `/notifications/subscribe` | Register push token (Expo/FCM/APNs) | Includes device metadata |
| DELETE | `/notifications/subscribe/{tokenId}` | Revoke push token | Soft delete |

### 7.7 Insights
| Method | Path | Description | Notes |
| --- | --- | --- | --- |
| GET | `/insights/summary` | Current metrics snapshot | Aggregated from Insights Engine |
| GET | `/insights/trends` | Trend data for requested metric & window | Query: `metric`, `window`, `compareTo` |

### 7.8 Audit & Admin (restricted)
| GET | `/audit-logs` | Filterable audit events | Admin scope only |
| POST | `/admin/stores/reset` | Reset tenant data (sandbox) | Protected by mTLS + admin role |

## 8. Sample Payloads
### 8.1 Create Plant
```json
POST /v1/plants
{
  "id": "p_01HY2R4Q4Z8T7",
  "nickname": "Monstera Deliciosa",
  "scientificName": "Monstera deliciosa",
  "acquiredAt": "2025-01-12",
  "status": "healthy",
  "imageRef": "gs://smart-plants/u_01HXFW1/p_01HY2R4Q4Z8T7.jpg",
  "location": { "room": "Living Room", "lightLevel": "medium" }
}
```
### 8.2 Analysis Result
```json
GET /v1/analyses/a_01HY2R6R8D7PG
{
  "data": {
    "id": "a_01HY2R6R8D7PG",
    "status": "completed",
    "plantName": "Monstera Deliciosa",
    "issues": [ { "code": "yellow_leaf", "severity": "moderate" } ],
    "score": 0.85,
    "recommendations": [
      { "id": "tip_water_adjust", "title": "ลดการรดน้ำ", "desc": "ลดความถี่ลงเหลือทุก 5 วัน" }
    ],
    "weatherSnapshot": { "tempC": 33, "humidity": 70, "condition": "sunny", "capturedAt": "2025-02-16T05:00:00Z" },
    "createdAt": "2025-02-16T05:02:01Z"
  },
  "meta": { "traceId": "01HY2R6TQ2Z9C", "degraded": false },
  "errors": []
}
```

## 9. Asynchronous & Eventing
- **Pub/Sub Topics**
  - `analysis.analyze`: triggered after upload confirmation; consumers handle ML inference, weather enrichment.
  - `notifications.dispatch`: drives push delivery (Expo/FCM/APNs) with retry + DLQ.
- **Webhooks**: Partners can subscribe to `analysis.completed`, `plant.status_changed` events. HMAC-SHA256 signature via `X-SmartPlant-Signature` header; 5-second timeout, 3 retries.
- **Real-time Channel**: WebSocket/SSE endpoint `/v1/rt` (JWT-secured) broadcasting analysis progress, notification counts, insight refresh triggers.

## 10. Data Governance & Compliance
- GDPR/PDPA aligned. `DELETE /users/me` initiates anonymization; hard delete after retention window or immediate if regulated request.
- Tenant data residency selectable (APAC, EU, US) at onboarding; enforced via storage policies.
- Encryption: AES-256 at rest; field-level encryption for activity notes and analysis issues.
- Data classification: PII, Sensitive (analysis), Operational; access controlled via IAM roles.

## 11. Performance & Reliability Targets
- **Latency**: Reads P50 120 ms / P95 280 ms; Writes P95 < 350 ms including persistence.
- **Throughput**: 120 requests/min per user with burst allowance; 429 response carries retry metadata.
- **Resilience**: Circuit breakers on AI/Weather dependencies; fallback returns cached insights with `meta.degraded=true`.
- **Availability**: 99.9% monthly SLO with error budget tracking; multi-region active-active deployment.

## 12. Observability & Testing
- Structured logs (JSON) enriched with `traceId`, `spanId`, `userId`, `tenant`.
- Metrics: `analysis.success_rate`, `plant.create_latency`, `notification.opt_in_rate`, `insights.compute_duration`.
- Distributed tracing via OpenTelemetry; dashboards in Grafana/Looker.
- Contract testing using OpenAPI 3.1 + Pact; synthetic monitoring from SEA/US regions.
- Chaos drills simulate AI outage, storage latency, notification queue backlog quarterly.

## 13. Security Controls
- mTLS for service-to-service calls; certificates rotated automatically.
- Secret management via cloud secret manager; 24-hour rotation for signing keys.
- Uploaded media scanned for malware & moderated for content policy before analysis.
- Abuse detection monitors abnormal upload/activity rates and suspicious login patterns.
- Static & dynamic application security tests integrated in CI; supply-chain scanning on dependencies.

## 14. Localization & Accessibility
- Responses include optional `localizedCopy` objects keyed by locale codes (`th`, `en`).
- Units default to Thai context (`ml`, `g`, `pcs`, `ล.`) with ability to switch to metric/imperial per user settings.
- Date/time formatting handled client-side; API provides raw UTC timestamps.

## 15. Open Issues & Decisions Required
1. Confirm retention policy for deleted plants (current default 30 days); specify override process for regulatory takedowns.
2. Determine premium-tier scope (e.g., advanced insights) before locking `Insights Engine` contract.
3. Validate marketplace integration requirements for `/plants/{id}/shop-links` before exposing endpoint.
4. Finalize localization fallback rules when requested locale content unavailable.

## 16. Approval Checklist
- [ ] Architecture review sign-off (API Guild)
- [ ] Security review sign-off (AppSec)
- [ ] Privacy impact assessment completed
- [ ] SLO targets ratified by SRE
- [ ] OpenAPI 3.1 specification generated and validated
- [ ] Reference implementation scaffolding approved

## 17. Next Steps
1. Produce OpenAPI 3.1 spec covering endpoints and schemas above; circulate for review.
2. Build reference service (NestJS/Go) implementing `/plants` and `/analyses` with CI contract tests.
3. Design Pub/Sub topics, retry policies, and schema registry for analysis pipeline events.
4. Define partner webhook onboarding workflow and developer portal requirements.

---
Prepared for development approval. Update this document when decisions in §15 are resolved or new capabilities emerge.
